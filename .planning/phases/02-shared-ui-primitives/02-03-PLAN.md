# Plan 02-03: Standardize error rendering to title + detail + hint

**Phase:** 2 -- Shared UI Primitives
**Estimated duration:** 25min
**Requirements addressed:** UI-04

## Goal

Every error path across all CLI commands renders errors in the structured title + detail + hint format via `printError()`. No raw `Error:` strings or bare stack traces appear in user-facing output. The `exitWithError()` pattern in newpr/cleanpr delegates to `printError()` for non-JSON output.

## Context

Plans 02-01 and 02-02 created the `src/lib/ui/` module and did the initial wiring. Plan 02-02 handled the main CLI entry points, top-level catch blocks, and wtlink/wt.ts error handlers. But several error paths within the CLI functions still use ad-hoc error formatting:

1. **newpr.ts `exitWithError()`** -- Non-JSON path just does `console.error(colors.error(message))` with no detail or hint
2. **newpr.ts checkout failure hint** -- Lines 1010-1021 render a multi-line hint using `progressError()` with `colors.info()` for hint lines (wrong color -- hints should be dim, not blue)
3. **cleanpr.ts specific-PR-not-found** -- Shows error + expected path, but not in title+detail+hint format
4. **cleanpr.ts `outputJsonError()`** -- Needs no change (JSON output), but the non-JSON parallel paths need standardization
5. **validate-manifest.ts** -- Shows `colors.red(colors.bold('Manifest validation failed:'))` then lists issues, then throws
6. **link-configs.ts safety warning** -- Uses `colors.red(colors.bold('  - DANGER:'))` inline

This plan does the final sweep: every error display path uses `printError()`.

## Steps

### Step 1: Refactor `exitWithError()` in newpr.ts

**Files:** `src/cli/newpr.ts`
**Action:** modify

Update the `exitWithError()` function to use `printError()` for non-JSON output:

```typescript
import { printError } from '../lib/ui/index.js';

function exitWithError(message: string, code: ErrorCode, useJson: boolean): never {
  if (useJson) {
    console.log(formatJsonResult(createErrorResult('newpr', code, message)));
  } else {
    const hint = getErrorSuggestion(code);
    printError({ title: message, hint });
  }
  process.exit(1);
}
```

This adds the hint (from `getErrorSuggestion`) to every non-JSON error, which was previously only shown in the top-level catch block. Errors like `GH_NOT_INSTALLED` or `WORKTREE_EXISTS` will now always show their suggestion.

### Step 2: Fix the checkout failure hint in newpr.ts

**Files:** `src/cli/newpr.ts`
**Action:** modify

Replace the checkout failure hint block (lines ~1009-1021) which uses `progressError()` with `colors.info()` (wrong semantic color for hints):

Before:

```typescript
progressError(options, colors.error('Checkout failed due to conflicting changes.'));
progressError(options, colors.info('Your staged changes are preserved. To resolve this, either:'));
progressError(options, colors.info('  1. Commit your changes first, then run newpr again'));
progressError(options, colors.info('  2. Stash your changes: git stash push'));
progressError(options, colors.info('  3. Use a different branch point'));
```

After:

```typescript
import { printError } from '../lib/ui/index.js';
// ...
printError({
  title: 'Checkout failed due to conflicting changes.',
  detail: 'Your staged changes are preserved in the index.',
  hint:
    'To resolve this, either:\n' +
    '  1. Commit your changes first, then run newpr again\n' +
    '  2. Stash your changes: git stash push\n' +
    '  3. Use a different branch point (e.g., HEAD instead of origin/main)',
});
```

This fixes the semantic color issue (hints are now dim, not blue) and uses the standard error format.

### Step 3: Standardize error output in cleanpr.ts

**Files:** `src/cli/cleanpr.ts`
**Action:** modify

**PR-not-found error in `cleanSpecific()` (lines ~378-385):**
Already partially done in 02-02. Ensure it uses the full title+detail+hint format:

```typescript
if (!target) {
  if (options.json) {
    outputJsonError(ErrorCode.PR_NOT_FOUND, `No worktree found for PR #${prNumber}`);
  } else {
    printError({
      title: `No worktree found for PR #${prNumber}`,
      detail: `Expected at: ${expectedPath}`,
      hint: 'Run "lswt" to see available worktrees.',
    });
  }
  process.exit(1);
}
```

**GH not installed error (lines ~459-469):**

```typescript
if (!github.isGhInstalled()) {
  if (options.json) {
    outputJsonError(ErrorCode.GH_NOT_INSTALLED, 'GitHub CLI (gh) is required');
  } else {
    printError({
      title: 'GitHub CLI (gh) is required for PR status checking.',
      hint: 'Install: https://cli.github.com/',
    });
  }
  process.exit(1);
}
```

**Not a git repo error (lines ~474-480):**

```typescript
if (!repoRoot) {
  if (options.json) {
    outputJsonError(ErrorCode.NOT_GIT_REPO, 'Not in a git repository');
  } else {
    printError({
      title: 'Not in a git repository.',
      hint: 'Run this command from within a git repository.',
    });
  }
  process.exit(1);
}
```

### Step 4: Standardize error output in lswt.ts

**Files:** `src/cli/lswt.ts`
**Action:** modify

**GH not installed warning (lines ~132-138):**
This is a warning, not an error -- it degrades gracefully. Use `printStatus('warning', ...)` with a dim hint:

```typescript
if (options.showStatus && !github.isGhInstalled()) {
  if (!options.json) {
    printStatus('warning', 'GitHub CLI (gh) not installed. PR status will not be shown.');
    printDim('Install: https://cli.github.com/');
  }
  options.showStatus = false;
}
```

**Not a git repo error (lines ~142-150):**

```typescript
if (!repoRoot) {
  if (options.json) {
    outputJsonError(ErrorCode.NOT_GIT_REPO, 'Not a git repository');
  } else {
    printError({
      title: 'Not a git repository.',
      hint: 'Run this command from within a git repository.',
    });
  }
  process.exit(1);
}
```

**Top-level catch "not a git repository" special case (lines ~177-183):**

```typescript
if (message.includes('not a git repository')) {
  if (jsonMode) {
    outputJsonError(ErrorCode.NOT_GIT_REPO, 'Not a git repository');
  } else {
    printError({
      title: 'Not a git repository',
      hint: 'Run this command from within a git repository.',
    });
  }
}
```

### Step 5: Standardize error output in validate-manifest.ts

**Files:** `src/lib/wtlink/validate-manifest.ts`
**Action:** modify

Add import:

```typescript
import { printError } from '../ui/index.js';
```

Replace the validation failure output in `run()` (lines ~195-201):

Before:

```typescript
console.error(colors.red(colors.bold('Manifest validation failed:')));
for (const issue of result.problems) {
  console.error(colors.red(`  - ${issue}`));
}
throw new Error(`${result.problems.length} validation issue(s) detected.`);
```

After:

```typescript
printError({
  title: 'Manifest validation failed',
  detail: result.problems.map((p) => `  - ${p}`).join('\n'),
  hint: 'Run "wtlink manage" to fix manifest issues.',
});
throw new Error(`${result.problems.length} validation issue(s) detected.`);
```

**Important — avoid double-display:** `validate-manifest.ts` should NOT print the error itself. Remove the `console.error` calls and only throw. The `wtlink.ts` `.fail()` handler (wired in 02-02) will catch the thrown error and display it via `printError()`. This ensures the user sees the error exactly once in title+detail+hint format.

So the final code should be:

```typescript
// Do NOT print here — let the caller (.fail() handler) display via printError()
throw new ManifestError(`${result.problems.length} validation issue(s) detected.`, result.problems);
```

If `ManifestError` doesn't carry the `problems` array, add it as a property (or pass the detail string via the `issues` field that `ManifestError` already has). The `.fail()` handler in `wtlink.ts` should then use `errorToDisplay(err)` to extract title+detail+hint.

### Step 6: Standardize the newpr `checkPrerequisites()` function

**Files:** `src/cli/newpr.ts`
**Action:** modify

The `checkPrerequisites()` function (lines 92-106) currently calls `process.exit(1)` directly after showing errors. Refactor to use `printError()`:

```typescript
function checkPrerequisites(): void {
  printStatus('info', 'Checking prerequisites...');

  if (!github.isGhInstalled()) {
    printError({
      title: 'GitHub CLI (gh) is required.',
      hint: 'Install: https://cli.github.com',
    });
    process.exit(1);
  }

  if (!github.isAuthenticated()) {
    printError({
      title: 'GitHub CLI not authenticated.',
      hint: 'Run: gh auth login',
    });
    process.exit(1);
  }

  printStatus('success', 'Prerequisites OK');
}
```

### Step 7: Write integration-style tests for error rendering

**Files:** `src/lib/ui/error.test.ts`
**Action:** modify (append to existing test file from 02-01)

Add test cases that verify the error rendering covers all key scenarios:

```typescript
describe('error rendering integration', () => {
  it('renders title-only error', () => {
    printError({ title: 'Something failed' });
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('✗'));
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('Something failed'));
  });

  it('renders title + detail + hint', () => {
    printError({
      title: 'Git checkout failed',
      detail: 'Conflicting changes in 3 files',
      hint: 'Stash or commit your changes first',
    });
    // Verify all three parts appear in stderr output (use content matching, not call count)
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('Git checkout failed'));
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('Conflicting changes'));
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('Stash or commit'));
  });

  it('renders multi-line hint', () => {
    printError({
      title: 'No worktree found',
      hint: 'Try one of:\n  1. Run lswt to check\n  2. Create with newpr',
    });
    // Hint lines should be dim
    expect(stderrSpy).toHaveBeenCalledWith(expect.stringContaining('Hint:'));
  });

  it('errorToDisplay extracts hint from error code', () => {
    const err = new Error('not a git repository');
    err.name = 'GitCommandError';
    const display = errorToDisplay(err);
    expect(display.title).toBe('not a git repository');
    expect(display.hint).toBeDefined();
  });

  it('suppresses all output in JSON mode', () => {
    setJsonMode(true);
    printError({ title: 'fail', detail: 'detail', hint: 'hint' });
    expect(stderrSpy).not.toHaveBeenCalled();
  });
});
```

### Step 8: Final audit -- verify no raw error patterns remain

**Files:** (read-only audit, no modifications)
**Action:** verify

Run these checks to confirm standardization is complete:

1. `grep -rn 'console\.error.*colors\.error' src/cli/` -- should only find lines inside JSON output branches or lines already converted
2. `grep -rn 'console\.error.*Error:' src/cli/` -- should find zero matches (the old `Error: ${message}` pattern)
3. `grep -rn 'colors\.error.*process\.exit' src/cli/` -- should find zero matches outside JSON paths
4. `grep -rn 'console\.error(msg)' src/cli/wt.ts` -- should find zero matches (was the colorless error)

If any matches are found, fix them by routing through `printError()`.

## Verification

- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] `npm test` passes -- all existing tests still pass plus new error rendering tests
- [ ] `grep -rn "console\.error.*'Error:" src/cli/` returns zero matches
- [ ] `grep -rn 'console\.error(msg)' src/cli/wt.ts` returns zero matches
- [ ] `grep -rn 'console\.error(err\.message)' src/cli/wt.ts` returns zero matches
- [ ] All `exitWithError()` calls in newpr.ts now include hints for non-JSON mode
- [ ] The checkout failure hint in newpr.ts uses dim color (not blue/info)
- [ ] validate-manifest.ts uses `printError()` for validation failure display
- [ ] Running any command with an intentional error (e.g., `newpr` outside a git repo) shows the title + hint format

## Notes

- The title + detail + hint format is for user-facing errors only. JSON output (`--json` flag) continues to use the structured `CommandResult` format with `ErrorInfo` -- `printError()` is completely suppressed in JSON mode.
- `exitWithError()` in newpr.ts is specific to newpr because it handles both JSON and non-JSON output and calls `process.exit(1)`. Other CLIs have their own exit patterns. The shared `printError()` deliberately does NOT call `process.exit()` -- the caller decides.
- The `printError()` function writes to stderr (via `printErr()`), which is correct for error output. This means errors go to stderr while normal output goes to stdout, maintaining proper stream separation for piping/scripting.
- validate-manifest.ts does NOT print the error — it only throws. The `wtlink.ts` `.fail()` handler displays the error via `printError()`. This avoids the double-display problem.
