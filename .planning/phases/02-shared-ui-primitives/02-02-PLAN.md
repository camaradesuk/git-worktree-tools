# Plan 02-02: Refactor CLI commands to use shared UI primitives

**Phase:** 2 -- Shared UI Primitives
**Estimated duration:** 30min
**Requirements addressed:** UI-01, UI-02, UI-03

## Goal

All five CLI entry points (`newpr.ts`, `cleanpr.ts`, `lswt.ts`, `wtlink.ts`, `wt.ts`) use shared UI primitives from `src/lib/ui/` for all structured output -- no inline `console.log(colors.something(...))` for status messages, headers, summaries, or next-steps blocks. JSON mode is wired through `setJsonMode()`.

## Context

Plan 02-01 created the `src/lib/ui/` module with `printStatus`, `printHeader`, `printDetail`, `printDim`, `printNextSteps`, `printSummaryBox`, `printTable`, `printError`, `changeIndicator`, `setJsonMode`, and `withSpinner`.

This plan refactors the CLI files to use those functions. The refactoring is mechanical -- replace inline `console.log(colors.X(...))` calls with the corresponding `ui.printX()` call.

Key constraints:

- Do NOT touch `src/lib/wtlink/manage-manifest.ts` (black box TUI)
- Do NOT touch `src/lib/lswt/interactive.ts` (raw terminal TUI)
- Do NOT touch `src/lib/wtlink/main-menu.ts` (interactive menu TUI)
- Preserve ALL existing behavior -- same output text, same colors, same exit codes
- JSON output (`--json` flag) must continue to work identically
- All 231+ existing tests must still pass
- `link-configs.ts` inconsistent icons (raw `✓` / `⚠️`) should be replaced with `colors.success()` / `colors.warning()` calls, but the overall structure of link-configs.ts remains (it has interactive prompts and its output is interspersed with user interaction)

## Steps

### Step 1: Wire `setJsonMode()` into all CLI init paths

**Files:** `src/cli/newpr.ts`, `src/cli/cleanpr.ts`, `src/cli/lswt.ts`, `src/cli/wtlink.ts`
**Action:** modify

In each CLI's initialization code (after parsing args, alongside `initializeLogger()`), add:

```typescript
import { setJsonMode } from '../lib/ui/index.js';
// ...
if (options.json) {
  setJsonMode(true);
}
```

Specific locations:

- **newpr.ts**: In `main()`, after `initializeLogger()` call (line ~1249), add `setJsonMode(options.json)`.
- **cleanpr.ts**: In `main()`, after `initializeLogger()` call (line ~447), add `setJsonMode(options.json)`.
- **lswt.ts**: In `main()`, after `initializeLogger()` call (line ~120), add `setJsonMode(options.json)`.
- **wtlink.ts**: In the yargs `.middleware()` callback (line ~104), add `setJsonMode(argv.json as boolean)` after `initializeLogger()`.

### Step 2: Refactor `newpr.ts` to use UI primitives

**Files:** `src/cli/newpr.ts`
**Action:** modify

Add import:

```typescript
import {
  printStatus,
  printDim,
  printSummaryBox,
  printNextSteps,
  setJsonMode,
} from '../lib/ui/index.js';
```

**Replace the `progress()` helper pattern:**
The existing `progress(options, colors.success(...))` pattern checks `!options.json` before logging. Since `setJsonMode()` is now called at init, all `ui.print*` functions already suppress in JSON mode. However, `progress()` is used for ALL output, not just structured status. Keep `progress()` for free-form output but replace structured patterns:

- `progress(options, colors.success('Prerequisites OK'))` -> `printStatus('success', 'Prerequisites OK')`
- `progress(options, colors.info('Checking prerequisites...'))` -> `printStatus('info', 'Checking prerequisites...')`
- `progress(options, colors.warning(...))` -> `printStatus('warning', ...)`
- `progress(options, colors.error(...))` -> `printStatus('error', ...)`

**Replace `checkPrerequisites()` function (lines 92-106):**
Replace `console.log(colors.info(...))` and `console.error(colors.error(...))` with `printStatus('info', ...)` and `printStatus('error', ...)`.

**Replace `printSummary()` function (lines 388-426):**
Replace the inline box-drawing output with `printSummaryBox()` and `printNextSteps()`:

```typescript
function printSummary(...): void {
  if (options.json) {
    // JSON output unchanged
    console.log(formatJsonResult(createSuccessResult('newpr', data)));
    return;
  }
  printSummaryBox(`PR #${prNumber} worktree ready!`, [
    { label: 'Branch', value: branchName },
    { label: 'Worktree', value: worktreePath },
    { label: 'PR URL', value: prUrl },
  ]);
  printNextSteps([
    { command: `cd ${worktreePath}` },
    { command: `gh pr view ${prNumber} --web`, description: 'Open PR in browser' },
    { command: 'wtlink link', description: 'Link config files from main worktree' },
  ]);
}
```

**Replace the AI-generated content indicator (line ~734):**
`progress(options, colors.info('✨ AI-generated PR content'))` -- Keep the `✨` emoji here since it's a unique one-off indicator, not a standard status icon. Just replace with `printStatus('info', '✨ AI-generated PR content')`.

**Replace the top-level catch block (lines 1303-1326):**
Use `errorToDisplay()` and `printError()` from ui/:

```typescript
import { printError, errorToDisplay } from '../lib/ui/index.js';
// ...
main().catch((error) => {
  const useJson = hasJsonFlag(process.argv.slice(2));
  if (error instanceof NonInteractiveError) {
    exitWithError(error.message, error.code, useJson);
  }
  if (useJson) {
    const message = error instanceof Error ? error.message : String(error);
    const code = getErrorCodeFromError(error);
    exitWithError(message, code, useJson);
  } else {
    const display = errorToDisplay(error);
    printError(display);
    process.exit(1);
  }
});
```

### Step 3: Refactor `cleanpr.ts` to use UI primitives

**Files:** `src/cli/cleanpr.ts`
**Action:** modify

Add import:

```typescript
import {
  printStatus,
  printHeader,
  printDim,
  printNextSteps,
  setJsonMode,
  changeIndicator,
} from '../lib/ui/index.js';
```

**Replace `printWorktree()` function (lines 92-95):**

```typescript
function printWorktree(w: WorktreeInfo): void {
  const ci = changeIndicator(w.hasChanges);
  console.log(`    PR #${w.prNumber}: ${w.branch}${ci}`);
}
```

Note: This changes `[has changes]` to `*` -- the standardized compact format.

**Replace status output in `interactiveClean()` (lines 182-295):**

- `console.log(colors.info('No PR worktrees found.'))` -> `printStatus('info', 'No PR worktrees found.')`
- `console.log(colors.bold('PR Worktrees:'))` -> `printHeader('PR Worktrees:')`
- `console.log(colors.success(...))` -> `printStatus('success', ...)`
- `console.log(colors.warning(...))` -> `printStatus('warning', ...)`
- The next-steps block at the end of `interactiveClean()` (lines 291-294) -> `printNextSteps([...])`

**Replace status output in `cleanAll()` (lines 300-358):**

- Same pattern: replace `console.log(colors.info(...))` with `printStatus('info', ...)`
- Replace next-steps block with `printNextSteps()`

**Replace status output in `cleanSpecific()` (lines 363-416):**

- `console.error(colors.error(...))` -> `printStatus('error', ...)` (note: printStatus uses stdout via print(), but for errors we want stderr -- use `printError({ title: ... })` for error messages that go to stderr)
- Specifically, the error case on lines 378-385: use `printError()`:
  ```typescript
  printError({
    title: `No worktree found for PR #${prNumber}`,
    detail: `Expected at: ${expectedPath}`,
  });
  ```
- Replace next-steps block with `printNextSteps()`

**Replace top-level catch block (lines 518-534):**
Same pattern as newpr -- use `errorToDisplay()` and `printError()` for non-JSON errors.

### Step 4: Refactor `lswt.ts` to use UI primitives

**Files:** `src/cli/lswt.ts`
**Action:** modify

Add import:

```typescript
import {
  printTable as sharedPrintTable,
  printStatus,
  printError,
  errorToDisplay,
  setJsonMode,
  changeIndicator,
} from '../lib/ui/index.js';
```

**Replace `printTable()` function (lines 56-96):**
The local `printTable()` builds a `TableOptions` object and delegates to the shared `printTable()`. Replace the entire function body:

```typescript
function printTable(worktrees: WorktreeDisplay[], options: ListOptions, cwd: string): void {
  if (worktrees.length === 0) {
    printStatus('info', 'No worktrees found.');
    return;
  }

  const repoName = path.basename(worktrees[0].path.replace(/\.pr\d+$/, ''));

  const rows = worktrees.map((wt) => {
    const { text, color } = formatTypeLabel(wt);
    const typeLabel = colorMap[color](text);
    const ci = changeIndicator(wt.hasChanges);

    const fields: Array<{ key: string; value: string }> = [
      { key: 'Branch', value: wt.branch || colors.dim('(detached)') },
      { key: 'Path', value: getDisplayPath(wt.path, cwd, options.verbose) },
    ];
    if (options.verbose) {
      fields.push({ key: 'Commit', value: colors.dim(wt.commit) });
    }

    return { label: typeLabel, indicator: ci, fields };
  });

  // Build summary
  const prCount = worktrees.filter((w) => w.type === 'pr').length;
  const openCount = worktrees.filter((w) => w.prState === 'OPEN').length;
  const changesCount = worktrees.filter((w) => w.hasChanges).length;
  const parts: string[] = [`${worktrees.length} worktrees`];
  if (prCount > 0) parts.push(`${prCount} PRs`);
  if (openCount > 0) parts.push(`${openCount} open`);
  if (changesCount > 0) parts.push(colors.red(`${changesCount} with changes`));

  sharedPrintTable({
    title: `${repoName} worktrees:`,
    rows,
    summary: parts.join(' · '),
  });
}
```

**Replace error output in top-level catch (lines 172-192):**
Use `printError()` and `errorToDisplay()` for non-JSON errors.

### Step 5: Refactor `wtlink.ts` error handling

**Files:** `src/cli/wtlink.ts`
**Action:** modify

Add import:

```typescript
import { printError, setJsonMode } from '../lib/ui/index.js';
```

**Extract duplicated error suggestion logic:**
The `.fail()` handler (lines 269-303) and `.catch()` handler (lines 312-340) have identical if/else chains matching error messages to suggestions. Extract into a helper function:

```typescript
function getWtlinkHint(message: string): string | undefined {
  if (message.includes('Unable to detect an alternate worktree')) {
    return (
      'You are running from the main worktree with only one worktree available.\n' +
      'To link config files, you need at least two worktrees.\n\n' +
      'To fix:\n' +
      '  1. Create a PR worktree: newpr "My feature"\n' +
      '  2. Then link configs: wtlink link . ../my-repo.pr42'
    );
  }
  if (message.includes('Failed to inspect git worktrees')) {
    return 'Specify the source path explicitly:\n  wtlink link /path/to/source /path/to/dest';
  }
  if (message.includes('not a git repository')) {
    return 'Run this command from within a git repository.';
  }
  if (message.includes('Manifest file not found')) {
    return 'Create a manifest first:\n  wtlink manage';
  }
  return undefined;
}
```

**Replace `.fail()` handler:**

```typescript
.fail((msg, err) => {
  if (err) {
    printError({ title: err.message, hint: getWtlinkHint(err.message) });
  } else {
    printError({ title: msg });
  }
  process.exit(1);
})
```

**Replace `.catch()` handler:**

```typescript
.catch((err) => {
  const message = err instanceof Error ? err.message : String(err);
  printError({ title: message, hint: getWtlinkHint(message) });
  process.exit(1);
});
```

This eliminates the duplication entirely -- both handlers use the same `getWtlinkHint()` + `printError()`.

### Step 6: Fix `wt.ts` error handling (add colors)

**Files:** `src/cli/wt.ts`
**Action:** modify

Add import:

```typescript
import { printError } from '../lib/ui/index.js';
```

**Replace `.fail()` handler (lines 149-156):**

```typescript
.fail((msg, err) => {
  if (err) {
    printError({ title: err.message });
  } else {
    printError({ title: msg });
  }
  process.exit(1);
})
```

**Replace `.catch()` handler (lines 158-161):**

```typescript
.catch((err) => {
  const message = err instanceof Error ? err.message : String(err);
  printError({ title: message });
  process.exit(1);
});
```

This fixes the gap where `wt.ts` had NO colors in error output.

### Step 7: Fix inconsistent icons in `link-configs.ts`

**Files:** `src/lib/wtlink/link-configs.ts`
**Action:** modify

Replace raw unicode icons with `colors.ts` semantic functions:

- Line 561: `colors.green('✓ Scanned ${filesToLink.length} files')` -> `console.log(colors.success('Scanned ${filesToLink.length} files'))` (uses `colors.success()` which provides green check icon)
- Line 569: `colors.yellow('\n⚠️  Found ${...} conflicting files\n')` -> `console.log(colors.warning('Found ${...} conflicting files'))` (uses `colors.warning()` which provides yellow warning icon)
- Lines 611-633: Replace raw icons in the summary section:
  - `colors.dim('  ✓ Already linked:')` -> `colors.dim('  ${icons.success} Already linked:')` (import `icons` from ui/theme.ts, or just use `colors.success()`)
  - `colors.yellow('  ⚠  Replace:')` -> use `colors.warning()`
  - `colors.blue('  ℹ  Ignore:')` -> use `colors.info()`
  - `colors.red('  ✗ Remove:')` -> use `colors.error()`
  - `colors.green('  ✓ Safe:')` -> use `colors.success()`

Note: link-configs.ts has extensive interactive output (conflict resolver, confirmation prompts). Do NOT attempt to route all of its output through ui/ print functions -- only fix the icon inconsistencies. The file's console.log calls are interspersed with `inquirer` prompts and would break if suppressed.

## Verification

- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] `npm test` passes -- all 231+ existing tests still pass
- [ ] `grep -rn 'console\.log(colors\.' src/cli/newpr.ts` returns zero matches (except inside JSON output branches)
- [ ] `grep -rn 'console\.log(colors\.' src/cli/cleanpr.ts` returns zero matches (except inside JSON output branches)
- [ ] `grep -rn 'console\.error(colors\.' src/cli/wt.ts` returns zero matches (wt.ts now uses printError)
- [ ] The duplicated error handling in wtlink.ts `.fail()` and `.catch()` is consolidated into a single `getWtlinkHint()` function
- [ ] Running `newpr --help`, `cleanpr --help`, `lswt --help` still shows help text correctly
- [ ] `wt.ts` `.fail()` and `.catch()` now produce colored error output (was previously raw text)
- [ ] `link-configs.ts` no longer contains raw `✓` or `⚠️` outside of the colors.ts function calls

## Notes

- The `progress()` helper in newpr.ts can be kept for truly free-form output (e.g., showing commit lists, git status output) that doesn't fit the printStatus/printHeader pattern. But structured status messages should go through ui/ functions.
- The `cleanpr.ts` change indicator switches from `[has changes]` to `*` via `changeIndicator()`. This is a minor visual change but standardizes the format across lswt and cleanpr.
- When refactoring `exitWithError()` in newpr.ts: keep it as-is for JSON mode (it outputs structured JSON), but for non-JSON mode it could delegate to `printError()`. However, since `exitWithError` also calls `process.exit(1)`, and `printError` doesn't exit, keep the exit in `exitWithError`. The change is replacing `console.error(colors.error(message))` with `printError({ title: message })`.
- Test files that mock `console.log` or `console.error` may need adjustment if the output format changes slightly. Check test assertions carefully.
