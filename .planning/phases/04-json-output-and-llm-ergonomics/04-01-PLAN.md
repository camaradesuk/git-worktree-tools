---
phase: 04-json-output-and-llm-ergonomics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/wtstate.ts
  - src/cli/wtlink.ts
  - src/cli/wt.ts
  - src/cli/wtconfig.ts
  - src/lib/prs/command.ts
  - src/lib/prs/types.ts
  - src/cli/prs.ts
  - src/cli/prs.test.ts
autonomous: true

must_haves:
  truths:
    - 'Running `wtstate --json` with invalid args outputs a CommandResult error JSON on stdout and exits 1'
    - 'Running `wt --json badcommand` outputs a CommandResult error JSON on stdout (not just human text to stderr)'
    - 'Running `wtlink --json badcommand` outputs a CommandResult error JSON on stdout'
    - 'Running `wtconfig show --json` outputs a CommandResult JSON with the merged config on stdout'
    - 'Running `wtconfig validate --json` outputs a CommandResult JSON with validation results on stdout'
    - 'Running `wtconfig get <key> --json` outputs a CommandResult JSON with the value on stdout'
    - 'Running `prs --json` outputs a CommandResult<PrsResultData> JSON (not PrsJsonOutput)'
  artifacts:
    - path: 'src/cli/wtstate.ts'
      provides: 'JSON-aware parse error and catch handler'
      contains: 'hasJsonFlag'
    - path: 'src/cli/wtlink.ts'
      provides: 'JSON-aware .fail() and .catch() handlers'
      contains: 'outputJsonError'
    - path: 'src/cli/wt.ts'
      provides: 'JSON-aware .fail() and .catch() handlers'
      contains: 'hasJsonFlag'
    - path: 'src/cli/wtconfig.ts'
      provides: 'JSON support for show/get/set/validate subcommands'
      contains: 'createSuccessResult'
    - path: 'src/lib/prs/command.ts'
      provides: 'Migrated JSON output using CommandResult<T>'
      contains: 'createSuccessResult'
  key_links:
    - from: 'src/cli/wtstate.ts'
      to: 'src/lib/json-output.ts'
      via: 'createErrorResult + formatJsonResult'
      pattern: 'hasJsonFlag.*createErrorResult'
    - from: 'src/cli/wt.ts'
      to: 'src/lib/json-output.ts'
      via: 'hasJsonFlag check in .fail()/.catch()'
      pattern: 'hasJsonFlag.*outputJsonError'
    - from: 'src/lib/prs/command.ts'
      to: 'src/lib/json-output.ts'
      via: 'createSuccessResult replaces manual PrsJsonOutput construction'
      pattern: 'createSuccessResult.*prs'
---

<objective>
Patch every CLI error path and missing JSON code path so that `--json` always produces valid `CommandResult<T>` JSON on stdout — including parse errors, `.fail()`, `.catch()`, and subcommands that previously had no JSON support.

Purpose: Requirement LLM-01 states every `wt` subcommand must output valid JSON in every code path when `--json` is passed. Currently 6 CLIs have gaps where error paths bypass JSON output, and `wtconfig` has no JSON support for most subcommands.

Output: All CLI entry points produce valid JSON in every code path; `prs` migrated from `PrsJsonOutput` to `CommandResult<T>`.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-json-output-and-llm-ergonomics/04-RESEARCH.md

@src/lib/json-output.ts
@src/cli/wtstate.ts
@src/cli/wtlink.ts
@src/cli/wt.ts
@src/cli/wtconfig.ts
@src/lib/prs/command.ts
@src/lib/prs/types.ts
@src/cli/prs.ts
@src/cli/lswt.ts (gold standard for JSON error handling pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Patch JSON gaps in wtstate, wtlink, wt, and wtconfig CLIs</name>
  <files>
    src/cli/wtstate.ts
    src/cli/wtlink.ts
    src/cli/wt.ts
    src/cli/wtconfig.ts
  </files>
  <action>
    Fix every error path that bypasses JSON output. Follow the gold-standard pattern from `src/cli/lswt.ts`:

    **wtstate.ts** (2 gaps):
    1. Lines 30-35: Parse error path. Add `hasJsonFlag` check (copy the function from lswt.ts pattern). When JSON mode, output `createErrorResult('wtstate', ErrorCode.INVALID_ARGUMENT, result.message || 'Invalid arguments')` via `formatJsonResult()` to stdout before `process.exit(1)`.
    2. Lines 98-101: `main().catch()` handler. Add `hasJsonFlag(process.argv.slice(2))` check. When JSON mode, output `createErrorResult('wtstate', ErrorCode.UNKNOWN_ERROR, message)` via `formatJsonResult()`.
    3. Add the `hasJsonFlag` utility function (identical to lswt.ts pattern: `return args.includes('--json')`).
    4. Add imports for `createErrorResult`, `formatJsonResult`, `ErrorCode` from `../lib/json-output.js` (some already imported, add missing ones).

    **wtlink.ts** (2 gaps):
    1. Lines 272-283: `.fail()` handler. After the existing `printError()` call, add: if `isJsonMode()` (import from `../lib/ui/index.js`), output `createErrorResult('wtlink', getErrorCodeFromError(err || new Error(msg)), err?.message || msg)` via `formatJsonResult()` to `console.log()`.
    2. Lines 292-300: `.catch()` handler. Same pattern — after `printError()`, check `isJsonMode()` and output JSON error result.
    3. Add imports for `createErrorResult`, `formatJsonResult`, `ErrorCode`, `getErrorCodeFromError` from `../lib/json-output.js` and `isJsonMode` from `../lib/ui/index.js`.
    NOTE: wtlink already calls `setJsonMode()` in middleware, so `isJsonMode()` is reliable here.

    **wt.ts** (2 gaps):
    1. Lines 169-176: `.fail()` handler. Add `hasJsonFlag(process.argv.slice(2))` check. When true, output `createErrorResult('wt', ErrorCode.INVALID_ARGUMENT, err?.message || msg)` via `console.log(formatJsonResult(...))` INSTEAD of `printError()` (not in addition — JSON mode means no human output).
    2. Lines 178-182: `.catch()` handler. Same pattern — check `hasJsonFlag`, output JSON error if true.
    3. Add a `hasJsonFlag` helper function: `function hasJsonFlag(args: string[]): boolean { return args.includes('--json'); }`.
    4. Add imports for `createErrorResult`, `formatJsonResult`, `ErrorCode` from `../lib/json-output.js`.

    **wtconfig.ts** — Add `--json` support to `show`, `get`, `validate` subcommands (skip `set`/`edit`/`init` which are interactive):
    1. Parse `--json` flag from args: `const jsonMode = args.includes('--json');`
    2. Pass `jsonMode` to `showConfig()`, `getConfig()`, `validateCurrentConfig()`.
    3. `showConfig(jsonMode)`: When jsonMode, output `createSuccessResult('wtconfig', { subcommand: 'show', source: source.type === 'none' ? null : source.path, config })` via `console.log(formatJsonResult(...))` and return early.
    4. `getConfig(key, jsonMode)`: When jsonMode, output `createSuccessResult('wtconfig', { subcommand: 'get', key, value })` via `console.log(formatJsonResult(...))`. For errors (unknown key), output `createErrorResult('wtconfig', ErrorCode.INVALID_ARGUMENT, msg)`.
    5. `validateCurrentConfig(jsonMode)`: When jsonMode, output `createSuccessResult('wtconfig', { subcommand: 'validate', valid: result.valid, errors: result.errors, warnings: result.warnings })`.
    6. `main().catch()` (line 65-67): Add `jsonMode` check. When true, output `createErrorResult('wtconfig', ErrorCode.UNKNOWN_ERROR, message)`.
    7. Add imports for `createSuccessResult`, `createErrorResult`, `formatJsonResult`, `ErrorCode` from `../lib/json-output.js`.
    8. Update `showHelp()` to include `--json` as a global option (not just under Migration Options).

  </action>
  <verify>
    Run `npm test` — all existing tests must pass. No tests should break from the error path changes since the human-readable output is preserved for non-JSON mode.
  </verify>
  <done>
    Every `.fail()`, `.catch()`, and parse-error path in wtstate, wtlink, wt, and wtconfig checks for JSON mode and outputs a valid `CommandResult` error JSON when `--json` is present. wtconfig show/get/validate subcommands support `--json` flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate prs JSON output to CommandResult<T> and add tests</name>
  <files>
    src/lib/prs/command.ts
    src/lib/prs/types.ts
    src/cli/prs.ts
    src/cli/prs.test.ts
  </files>
  <action>
    Migrate the `prs` command from `PrsJsonOutput` to `CommandResult<PrsResultData>`:

    **src/lib/prs/types.ts:**
    1. Deprecate `PrsJsonOutput` interface — add `@deprecated Use CommandResult<PrsResultData> instead` JSDoc comment. Keep the type for backward compatibility but mark it deprecated.
    2. Add a new `PrsResultData` interface:
       ```typescript
       export interface PrsResultData {
         total: number;
         filters: {
           states: string[];
           showDrafts: boolean | 'only';
           labels: string[];
           author: string | null;
           hasWorktree: boolean | null;
         };
         prs: PrDisplayItem[];
       }
       ```

    **src/lib/prs/command.ts:**
    1. Replace the `PrsJsonOutput` import with `PrsResultData` import.
    2. Replace the manual JSON construction (lines 166-182) with:
       ```typescript
       const filteredPrs = applyFilters(prs, filterState);
       const result = createSuccessResult<PrsResultData>('prs', {
         total: filteredPrs.length,
         filters: {
           states: Array.from(filterState.states),
           showDrafts: filterState.showDrafts,
           labels: filterState.labels,
           author: filterState.author,
           hasWorktree: filterState.hasWorktree,
         },
         prs: filteredPrs,
       });
       console.log(formatJsonResult(result));
       ```
    3. Add import for `createSuccessResult` from `../json-output.js` (it already imports `createErrorResult` and `formatJsonResult`).

    **src/cli/prs.test.ts:**
    1. Update any test that checks the shape of JSON output to expect `CommandResult<PrsResultData>` envelope (with `success`, `command`, `timestamp`, `data`, optional `error`, optional `warnings`).
    2. Add a test verifying the `prs --json` output includes all `CommandResult` fields.
    3. Add tests for the patched error paths if not already covered.

    **src/cli/prs.ts:**
    No changes expected (it re-exports from command.ts). Verify re-exports still work.

    This migration is backward-compatible: `CommandResult` has the same top-level fields (`success`, `command`, `timestamp`, `data`) as `PrsJsonOutput`, just adds `error` and `warnings`.

  </action>
  <verify>
    Run `npm test` — all existing tests must pass. Verify the prs JSON output shape with a grep for `PrsJsonOutput` to ensure it's only used in the deprecated type declaration, not in production code paths.
  </verify>
  <done>
    `prs --json` outputs `CommandResult<PrsResultData>` using `createSuccessResult()` and `formatJsonResult()`. The deprecated `PrsJsonOutput` type remains but is not used in production code. Tests validate the new output shape.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes (all existing + new tests)
2. Manual audit: grep for `process.exit(1)` in all CLI files and verify each one has a JSON-mode check within 10 lines above it
3. grep for `console.error` in CLI catch/fail handlers — all must be inside `else` branch of a JSON check (or inside non-JSON-mode conditional)
4. grep for `PrsJsonOutput` — should only appear in types.ts as `@deprecated` and in test import, not in production command.ts
</verification>

<success_criteria>

- Every CLI's `.fail()`, `.catch()`, and parse-error paths check JSON mode and output `CommandResult` error JSON when `--json` is present
- `wtconfig show --json`, `wtconfig get <key> --json`, `wtconfig validate --json` produce valid JSON
- `prs --json` uses `CommandResult<PrsResultData>` instead of custom `PrsJsonOutput`
- All 3134+ existing tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/04-json-output-and-llm-ergonomics/04-01-SUMMARY.md`
</output>
