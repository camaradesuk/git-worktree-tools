---
phase: 04-json-output-and-llm-ergonomics
plan: 04
type: execute
wave: 2
depends_on: ['04-01', '04-02']
files_modified:
  - src/cli/wt/completion.ts
  - src/cli/wt/completion.test.ts
autonomous: true

must_haves:
  truths:
    - 'zsh completion script includes prs and init subcommands'
    - 'fish completion script includes prs and init subcommands'
    - 'zsh completion for state includes --verbose, --base-branch, --json flags'
    - 'zsh completion for clean includes --delete-remote flag'
    - 'zsh completion for config lists set, get, validate, migrate subcommands'
    - 'fish completion for prs includes --state, --author, --label, --json, --no-interactive flags'
    - 'All three completion scripts (bash, zsh, fish) are syntactically valid'
  artifacts:
    - path: 'src/cli/wt/completion.ts'
      provides: 'Updated bash, zsh, and fish completion scripts'
      contains: 'prs'
    - path: 'src/cli/wt/completion.test.ts'
      provides: 'Tests verifying completion scripts include all subcommands and key flags'
      contains: 'prs'
  key_links:
    - from: 'src/cli/wt/completion.ts (ZSH_COMPLETION)'
      to: 'src/cli/wt.ts (subcommand definitions)'
      via: 'Subcommand list must match'
      pattern: 'prs.*init'
    - from: 'src/cli/wt/completion.ts (FISH_COMPLETION)'
      to: 'src/cli/wt.ts (subcommand definitions)'
      via: 'Subcommand list must match'
      pattern: 'prs.*init'
---

<objective>
Update all three shell completion scripts (bash, zsh, fish) to include all current subcommands and flags — especially the missing `prs` and `init` commands, and the missing flags identified in the research audit.

Purpose: Requirement LLM-04 states `wt completion` must generate working completions for all subcommands and flags. The research found that zsh and fish scripts are missing `prs` and `init` subcommands, `config` is missing 4 subcommands, and several individual command flags are missing.

Output: All three completion scripts enumerate all current subcommands and flags accurately.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-json-output-and-llm-ergonomics/04-RESEARCH.md
@.planning/phases/04-json-output-and-llm-ergonomics/04-02-SUMMARY.md

@src/cli/wt/completion.ts
@src/cli/wt.ts (subcommand registry - source of truth for commands)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update zsh and fish completion scripts with missing subcommands and flags</name>
  <files>src/cli/wt/completion.ts</files>
  <action>
    Update `ZSH_COMPLETION` and `FISH_COMPLETION` string constants to match the full current command surface. Use the research audit table as the gap list.

    **ZSH_COMPLETION updates:**
    1. Add `prs` and `init` to the `commands` array:
       ```
       'prs:Browse repository pull requests'
       'init:Initialize local/global configuration'
       ```
    2. Add prs case to the `args` switch:
       ```
       prs)
         _arguments \
           '--state[Filter by PR state]:state:(open closed merged all)' \
           '--author[Filter by author]:author:' \
           '--label[Filter by label]:label:' \
           '--draft[Show only draft PRs]' \
           '--no-draft[Exclude draft PRs]' \
           '--with-worktree[Show only PRs with local worktrees]' \
           '--limit[Maximum PRs to fetch]:number:' \
           '--json[Output as JSON]' \
           '--no-interactive[Disable interactive mode]' \
           '--refresh[Force refresh from GitHub]'
         ;;
       ```
    3. Add init case (no flags — purely interactive):
       ```
       init)
         _arguments \
           '--help[Show help]'
         ;;
       ```
    4. Fix state completions — add `--verbose`, `--base-branch`:
       ```
       state|s)
         _arguments \
           '--json[Output as JSON]' \
           '--verbose[Show detailed state information]' \
           '--base-branch[Base branch to compare against]:branch:' \
           '--quiet[Only output state name]'
         ;;
       ```
    5. Fix clean completions — add `--delete-remote`:
       ```
       clean|c)
         _arguments \
           '1:pr-number:' \
           '--all[Clean all merged/closed worktrees]' \
           '--dry-run[Show what would be cleaned]' \
           '--force[Force cleanup even with uncommitted changes]' \
           '--json[Output result as JSON]' \
           '--delete-remote[Delete remote branches after cleaning]'
         ;;
       ```
    6. Fix config completions — add missing subcommands:
       ```
       config|cfg)
         _arguments \
           '1:command:(show set get edit validate migrate init)' \
           '--json[Output as JSON]' \
           '--help[Show help]'
         ;;
       ```
    7. Fix list completions — add `--refresh`:
       ```
       list|ls)
         _arguments \
           '--verbose[Show full paths and commit hashes]' \
           '--json[Output as JSON]' \
           '--no-status[Skip GitHub PR status lookup]' \
           '--no-interactive[Disable interactive mode]' \
           '--filter[Filter worktrees by type]:filter:(pr main feature)' \
           '--refresh[Force refresh PR status from GitHub]'
         ;;
       ```
    8. Fix new completions — add complete action values:
       ```
       new|n)
         _arguments \
           '1:description:' \
           '--pr[Existing PR number]:number:' \
           '--draft[Create as draft PR]' \
           '--json[Output result as JSON]' \
           '--non-interactive[Run without prompts]' \
           '--action[Action to take]:action:(empty_commit commit_staged commit_all stash_and_empty use_commits push_then_branch use_commits_and_commit_all use_commits_and_stash create_pr_for_branch pr_for_branch_commit_all pr_for_branch_stash branch_from_detached)' \
           '--stash-untracked[Also stash untracked files]' \
           '--branch[Custom branch name]:branch:' \
           '--base[Base branch for PR]:branch:' \
           '--install[Run install command after setup]' \
           '--code[Open in VS Code after setup]' \
           '--ready[Mark PR as ready (not draft)]' \
           '--no-wtlink[Skip worktree linking step]' \
           '--no-hooks[Skip post-worktree hooks]'
         ;;
       ```

    **FISH_COMPLETION updates:**
    1. Add prs and init to main commands section:
       ```
       complete -c wt -n '__fish_use_subcommand' -a 'prs' -d 'Browse repository pull requests'
       complete -c wt -n '__fish_use_subcommand' -a 'init' -d 'Initialize configuration'
       ```
    2. Add prs options section:
       ```
       # prs options
       complete -c wt -n '__fish_seen_subcommand_from prs' -l state -d 'Filter by PR state' -ra 'open closed merged all'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l author -d 'Filter by author' -r
       complete -c wt -n '__fish_seen_subcommand_from prs' -l label -d 'Filter by label' -r
       complete -c wt -n '__fish_seen_subcommand_from prs' -l draft -d 'Show only draft PRs'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l no-draft -d 'Exclude draft PRs'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l with-worktree -d 'Only PRs with local worktrees'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l limit -d 'Maximum PRs to fetch' -r
       complete -c wt -n '__fish_seen_subcommand_from prs' -l json -d 'Output as JSON'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l no-interactive -d 'Disable interactive mode'
       complete -c wt -n '__fish_seen_subcommand_from prs' -l refresh -d 'Force refresh from GitHub'
       ```
    3. Fix state options — add missing flags:
       ```
       complete -c wt -n '__fish_seen_subcommand_from state s' -l verbose -s v -d 'Show detailed state info'
       complete -c wt -n '__fish_seen_subcommand_from state s' -l base-branch -d 'Base branch to compare against' -r
       ```
    4. Fix clean options — add `--delete-remote`:
       ```
       complete -c wt -n '__fish_seen_subcommand_from clean c' -l delete-remote -d 'Delete remote branches'
       ```
    5. Fix config subcommands — add missing ones:
       ```
       complete -c wt -n '__fish_seen_subcommand_from config cfg' -a 'set' -d 'Set config value'
       complete -c wt -n '__fish_seen_subcommand_from config cfg' -a 'get' -d 'Get config value'
       complete -c wt -n '__fish_seen_subcommand_from config cfg' -a 'validate' -d 'Validate config'
       complete -c wt -n '__fish_seen_subcommand_from config cfg' -a 'migrate' -d 'Migrate legacy config'
       ```
    6. Fix list options — add `--refresh`:
       ```
       complete -c wt -n '__fish_seen_subcommand_from list ls' -l refresh -d 'Force refresh PR status'
       ```
    7. Fix new options — add missing flags and complete action values:
       Add `--branch`, `--base`, `--install`, `--code`, `--ready`, `--no-wtlink`, `--no-hooks` completions.
       Update `--action` to include all 12 values.

    **BASH_COMPLETION:** No changes needed — bash delegates to yargs `--get-yargs-completions` which is always up to date. Leave as-is.

  </action>
  <verify>
    Run `npm test` — all existing tests pass. Manually review the zsh and fish completion strings to ensure they contain all subcommands and flags from the research audit table.
  </verify>
  <done>
    ZSH and fish completion scripts include `prs` and `init` subcommands. All flags for all subcommands are present in both scripts. Bash completion unchanged (delegates to yargs).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests verifying completion script coverage</name>
  <files>src/cli/wt/completion.test.ts</files>
  <action>
    Create `src/cli/wt/completion.test.ts` to verify all completion scripts include required subcommands and flags:

    1. Import the `completionCommand` from `./completion.js`.
    2. To access the completion strings, either:
       a. Export the `BASH_COMPLETION`, `ZSH_COMPLETION`, `FISH_COMPLETION` constants from completion.ts (add `export` keyword), OR
       b. Call the handler with mocked console.log and capture output for each shell.
       Prefer option (a) — export the constants. They're static strings, no reason to hide them.

    3. Test suite "Shell completion scripts":

       **Subcommand presence tests** (for zsh and fish):
       - Test: "zsh completion includes all subcommands" — assert ZSH_COMPLETION includes 'prs', 'init', 'new', 'list', 'clean', 'link', 'state', 'config', 'completion'.
       - Test: "fish completion includes all subcommands" — assert FISH_COMPLETION includes 'prs', 'init', 'new', 'list', 'clean', 'link', 'state', 'config', 'completion'.

       **Flag presence tests** (spot checks for previously missing flags):
       - Test: "zsh state completion includes --base-branch" — assert ZSH_COMPLETION includes 'base-branch'.
       - Test: "zsh clean completion includes --delete-remote" — assert ZSH_COMPLETION includes 'delete-remote'.
       - Test: "zsh list completion includes --refresh" — assert ZSH_COMPLETION includes 'refresh'.
       - Test: "zsh config completion includes set/get/validate/migrate" — assert ZSH_COMPLETION includes 'set', 'get', 'validate', 'migrate'.
       - Test: "fish prs completion includes --state and --json" — assert FISH_COMPLETION includes 'state' in prs context and '--json'.
       - Test: "fish state completion includes --base-branch" — assert FISH_COMPLETION includes 'base-branch'.

       **Structural tests:**
       - Test: "bash completion is a valid bash script" — assert BASH_COMPLETION includes '###-begin-wt-completions-###' and '###-end-wt-completions-###'.
       - Test: "zsh completion starts with #compdef wt" — assert ZSH_COMPLETION starts with '#compdef wt'.
       - Test: "fish completion disables file completions" — assert FISH_COMPLETION includes 'complete -c wt -f'.

    4. Keep tests simple — string contains checks. These are static completion scripts, not dynamic behavior.

  </action>
  <verify>
    Run `npm test -- src/cli/wt/completion.test.ts` — all new tests pass.
  </verify>
  <done>
    Test file verifies all three completion scripts include all expected subcommands and flags. Tests catch any future regression where a new subcommand or flag is added but not reflected in completions.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes (all existing + new tests)
2. `wt completion zsh` output includes `prs` and `init` subcommands
3. `wt completion fish` output includes `prs` and `init` subcommands
4. All flag gaps from research audit are filled in both zsh and fish scripts
5. Completion test file catches the 8+ specific gaps identified in research
</verification>

<success_criteria>

- ZSH and fish completion scripts include all 9 subcommands (new, list, clean, link, state, config, prs, init, completion)
- All flag gaps (--base-branch, --delete-remote, --refresh, config subcommands, prs flags) are filled
- Tests verify subcommand and flag presence
- Bash completion unchanged (yargs-delegated)
- All 3134+ existing tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/04-json-output-and-llm-ergonomics/04-04-SUMMARY.md`
</output>
