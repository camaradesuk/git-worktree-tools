---
phase: 03-interactive-menu-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/prs/command.ts
  - src/cli/wt/prs.ts
  - src/cli/prs.ts
  - src/lib/prs/command.test.ts
autonomous: true

must_haves:
  truths:
    - 'wt prs lists PRs with working refresh support via a single shared code path'
    - 'The standalone prs command continues to work identically to before'
    - 'No duplicate runPrsCommand function exists across the codebase'
  artifacts:
    - path: 'src/lib/prs/command.ts'
      provides: 'Single canonical runPrsCommand implementation with refreshPrs support'
      exports: ['runPrsCommand']
    - path: 'src/cli/wt/prs.ts'
      provides: 'Yargs command module importing from lib/prs/command.ts'
      contains: 'import.*runPrsCommand.*from.*lib/prs/command'
    - path: 'src/cli/prs.ts'
      provides: 'Standalone CLI entry point importing from lib/prs/command.ts'
      contains: 'import.*runPrsCommand.*from.*lib/prs/command'
  key_links:
    - from: 'src/cli/wt/prs.ts'
      to: 'src/lib/prs/command.ts'
      via: 'import runPrsCommand'
      pattern: 'from.*lib/prs/command'
    - from: 'src/cli/prs.ts'
      to: 'src/lib/prs/command.ts'
      via: 'import runPrsCommand'
      pattern: 'from.*lib/prs/command'
    - from: 'src/lib/prs/command.ts'
      to: 'src/lib/prs/interactive.ts'
      via: 'createDefaultPrInteractiveDeps with refreshPrs callback'
      pattern: 'createDefaultPrInteractiveDeps'
---

<objective>
Eliminate the duplicate `runPrsCommand()` code path that causes `wt prs` to lack refresh support (MENU-03). Extract the shared prs logic to `src/lib/prs/command.ts` and have both entry points import it.

Purpose: `wt prs` currently uses an incomplete copy of `runPrsCommand()` in `src/cli/wt/prs.ts` that is missing the `refreshPrs` callback, making the "r" key do nothing in interactive mode. After this plan, there is one canonical implementation that both `wt prs` and standalone `prs` use.

Output: New `src/lib/prs/command.ts` with the complete implementation; both `src/cli/wt/prs.ts` and `src/cli/prs.ts` thin wrappers importing from it.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interactive-menu-reliability/03-RESEARCH.md
@src/cli/prs.ts
@src/cli/wt/prs.ts
@src/lib/prs/interactive.ts
@src/lib/prs/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract runPrsCommand to lib/prs/command.ts and rewire both entry points</name>
  <files>src/lib/prs/command.ts, src/cli/wt/prs.ts, src/cli/prs.ts</files>
  <action>
**Create `src/lib/prs/command.ts`:**

Extract the `runPrsCommand()` function from `src/cli/prs.ts` (the complete version with `refreshPrs` support) into a new `src/lib/prs/command.ts` file. This is the canonical implementation.

The file should:

1. Import all dependencies currently used by `runPrsCommand` in `src/cli/prs.ts`:
   - `path`, `git`, `colors`, `loadConfig`, `isGhInstalled`, `isAuthenticated`, `getRepoInfo`
   - `fetchPrsWithWorktrees`, `applyFilters`, `clearPrCache`, `createDefaultDataDeps` from `./data.js`
   - `createDefaultFilterState`, `PrsCommandOptions`, `PrDisplayItem`, `PrsJsonOutput` from `./types.js`
   - `formatPrListHeader`, `formatPrSummary`, `formatPrTable` from `./formatters.js`
   - `runPrInteractiveMode`, `createDefaultPrInteractiveDeps` from `./interactive.js`
   - `createErrorResult`, `formatJsonResult`, `ErrorCode`, `getErrorSuggestion` from `../json-output.js`
2. Export `runPrsCommand(options: PrsCommandOptions): Promise<void>`
3. Also export `outputJsonError(code: ErrorCode, message: string): void` (used by both entry points for error handling)
4. The implementation is a direct copy of `runPrsCommand` from `src/cli/prs.ts` (lines 55-221), including the `createDefaultPrInteractiveDeps()` + `refreshPrs` callback wiring

**Update `src/cli/prs.ts`:**

1. Remove the `runPrsCommand()` function body (it now lives in `lib/prs/command.ts`)
2. Remove all imports that were only used by `runPrsCommand` (git, colors, loadConfig, github, prs/data, prs/types, prs/formatters, prs/interactive, json-output)
3. Add import: `import { runPrsCommand, outputJsonError } from '../lib/prs/command.js'`
4. Keep the `hasJsonFlag()` function (used by the standalone main catch block)
5. Keep the `main()` function and its yargs setup
6. Keep the `isMain` check and `main().catch()` handler
7. Keep the `export` on `runPrsCommand` (re-export from lib) and `outputJsonError` and `hasJsonFlag` for any downstream consumers

**Update `src/cli/wt/prs.ts`:**

1. Remove the entire local `runPrsCommand()` function (lines 58-213) and `outputJsonError()` function (lines 50-53)
2. Remove all imports that were only used by the local `runPrsCommand` (git, colors, loadConfig, github, prs/data, prs/types, prs/formatters, prs/interactive, json-output)
3. Add import: `import { runPrsCommand } from '../../lib/prs/command.js'`
4. Keep the `PrsArgs` interface
5. Keep the `prsCommand` yargs CommandModule export with its builder and handler
6. The handler should call the imported `runPrsCommand(options)` — same as before but now using the shared implementation

**Critical check:** The `runPrsCommand` in `lib/prs/command.ts` must include the `createDefaultPrInteractiveDeps()` + `refreshPrs` wiring. This is the whole point — `wt prs` will now get refresh support that it was missing.
</action>
<verify>Run `npm run build` — no TypeScript errors. Grep for `runPrsCommand` across all `.ts` files: should appear in exactly 3 files (lib/prs/command.ts definition, cli/prs.ts import+re-export, cli/wt/prs.ts import+usage). Grep `src/cli/wt/prs.ts` for `createDefaultPrInteractiveDeps` — should NOT appear (it's in lib/prs/command.ts now). Grep `src/cli/prs.ts` for `fetchPrsWithWorktrees` — should NOT appear (moved to lib).</verify>
<done>There is exactly one `runPrsCommand()` implementation in `src/lib/prs/command.ts`. Both `src/cli/prs.ts` and `src/cli/wt/prs.ts` import and use it. The `refreshPrs` callback is wired in the shared implementation, so `wt prs` now has working refresh.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for the extracted prs command module</name>
  <files>src/lib/prs/command.test.ts</files>
  <action>
Create `src/lib/prs/command.test.ts` to test the extracted `runPrsCommand` function. Mock all external dependencies (git, github, prs/data, prs/interactive, prs/formatters, json-output, config, colors).

**Required test cases:**

1. **Non-interactive mode outputs table:**
   - Mock `process.stdout.isTTY = false` (or pass `noInteractive: true`)
   - Verify `formatPrListHeader`, `formatPrSummary`, `formatPrTable` are called
   - Verify `runPrInteractiveMode` is NOT called

2. **Interactive mode creates deps with refreshPrs:**
   - Mock `process.stdout.isTTY = true` and `process.stdin.isTTY = true`
   - Call `runPrsCommand({ state: 'open', limit: 50 })`
   - Capture the `interactiveDeps` argument passed to `runPrInteractiveMode`
   - Verify `interactiveDeps.refreshPrs` is a function (the key regression test)
   - Verify `runPrInteractiveMode` was called with 5 arguments (prs, repoName, previewLabel, filterState, interactiveDeps)

3. **JSON mode outputs JSON:**
   - Call with `json: true`
   - Verify `console.log` was called with valid JSON
   - Verify `runPrInteractiveMode` is NOT called

4. **Force refresh clears cache:**
   - Call with `refresh: true`
   - Verify `clearPrCache()` was called before `fetchPrsWithWorktrees`

5. **Error handling — not a git repo:**
   - Mock `git.getRepoRoot()` to throw
   - Verify `process.exit(1)` is called
   - In JSON mode, verify `outputJsonError` style output

6. **Filter state from options:**
   - Call with `state: 'all'` — verify filterState.states includes OPEN, MERGED, CLOSED
   - Call with `draft: true` — verify filterState.showDrafts is 'only'

**Mock pattern:** Follow the established pattern from `interactive-menu.test.ts`:

```typescript
vi.mock('../../lib/git.js', () => ({ getRepoRoot: vi.fn(() => '/mock/repo') }));
vi.mock('../../lib/github.js', () => ({
  isGhInstalled: vi.fn(() => true),
  isAuthenticated: vi.fn(() => true),
  getRepoInfo: vi.fn(() => ({ name: 'test-repo' })),
}));
```

Mock `process.exit` as `vi.fn()` to prevent test process from exiting.

**Note:** The `refreshPrs` callback test is the critical regression test. It verifies that `wt prs` now gets refresh support. Structure the test to capture the deps argument:

```typescript
const mockRunPrInteractiveMode = vi.mocked(runPrInteractiveMode);
// ...call runPrsCommand...
const interactiveDeps = mockRunPrInteractiveMode.mock.calls[0][4];
expect(interactiveDeps).toBeDefined();
expect(interactiveDeps?.refreshPrs).toBeInstanceOf(Function);
```

  </action>
  <verify>Run `npm test -- src/lib/prs/command.test.ts` — all tests pass. Run `npm test` — full suite passes with no regressions.</verify>
  <done>Tests confirm: (a) runPrsCommand is a single shared implementation, (b) interactive mode creates deps with refreshPrs callback, (c) JSON mode, non-interactive mode, error handling all work correctly, (d) filter state is correctly built from options.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors
2. `npm test -- src/lib/prs/command.test.ts` — all tests pass
3. `npm test` — full test suite passes, no regressions
4. Grep `runPrsCommand` across all `.ts` files — defined in exactly 1 file (`lib/prs/command.ts`), imported in 2 files (`cli/prs.ts`, `cli/wt/prs.ts`)
5. Grep `createDefaultPrInteractiveDeps` in `src/cli/wt/prs.ts` — should NOT appear (was the missing import that caused the bug)
6. Grep `createDefaultPrInteractiveDeps` in `src/lib/prs/command.ts` — should appear (the fix)
</verification>

<success_criteria>

- `wt prs` in interactive mode has a working refresh callback (the "r" key fetches fresh data)
- The standalone `prs` command works identically to before
- There is exactly one `runPrsCommand` implementation in the codebase
- Both entry points import from `src/lib/prs/command.ts`
- No duplicate code between `src/cli/wt/prs.ts` and `src/cli/prs.ts`
  </success_criteria>

<output>
After completion, create `.planning/phases/03-interactive-menu-reliability/03-02-SUMMARY.md`
</output>
