---
phase: 01-logger-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logger.ts
  - src/lib/constants.ts
  - src/lib/colors.ts
  - src/lib/config.ts
  - src/lib/global-config.ts
  - src/lib/global-check.ts
  - src/lib/wtlink/config-manifest.ts
  - src/lib/config-migration/runner.ts
  - src/lib/config-migration/detector.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - 'Importing { logger } from src/lib/logger.js returns a consola-based singleton (not the old hand-rolled Logger class)'
    - 'initializeLogger() configures consola level, AuditFileReporter, and ConditionalStderrReporter based on flags/env'
    - 'Audit log entries are written to platform-specific XDG data directory with 10MB size-based rotation'
    - 'WARN and ERROR always print to stderr; DEBUG/INFO only print to stderr when verbose=true'
    - 'setColorEnabled(false) in colors.ts disables all ANSI codes in subsequent calls'
    - 'All 7 existing logger consumers compile and work with the new consola API'
  artifacts:
    - path: 'src/lib/logger.ts'
      provides: 'consola-based logger singleton with audit file + stderr reporters'
      exports: ['logger', 'initializeLogger', 'setAuditContext', 'parseLogLevel']
    - path: 'src/lib/constants.ts'
      provides: 'getGlobalDataDir() for audit log path'
      exports: ['getGlobalDataDir']
    - path: 'src/lib/colors.ts'
      provides: 'mutable color state'
      exports: ['setColorEnabled']
  key_links:
    - from: 'src/lib/logger.ts'
      to: 'src/lib/constants.ts'
      via: 'getGlobalDataDir() for audit log file path'
      pattern: 'getGlobalDataDir'
    - from: 'src/lib/logger.ts'
      to: 'consola'
      via: 'createConsola() factory'
      pattern: 'createConsola'
    - from: 'src/lib/config.ts'
      to: 'src/lib/logger.ts'
      via: 'import { logger }'
      pattern: "logger\\.debug|logger\\.warn"
---

<objective>
Replace the hand-rolled `src/lib/logger.ts` singleton with a `consola@^3.4.2` wrapper. Add `getGlobalDataDir()` to `constants.ts` for platform-specific audit log paths. Make `colors.ts` color state mutable so `--no-color` flags can take effect after import time. Update all 7 existing logger consumers to the new consola-compatible API.

Purpose: Establish the logger foundation that all CLI entry points will wire into (Plans 02 and 03). Without this, no other Phase 1 work can proceed.

Output: Working consola-based logger with audit file reporter, stderr reporter, and all library consumers compiling.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-logger-wiring/01-CONTEXT.md
@.planning/phases/01-logger-wiring/01-RESEARCH.md
@src/lib/logger.ts
@src/lib/constants.ts
@src/lib/colors.ts
@src/lib/config.ts
@src/lib/global-config.ts
@src/lib/global-check.ts
@src/lib/wtlink/config-manifest.ts
@src/lib/config-migration/runner.ts
@src/lib/config-migration/detector.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install consola and replace logger.ts with consola wrapper</name>
  <files>
    package.json
    src/lib/logger.ts
  </files>
  <action>
1. Run `npm install consola@^3.4.2` to add consola as a dependency.

2. **Completely rewrite** `src/lib/logger.ts` (do NOT extend the existing implementation — per user decision, replace it). The new module must:

   **Exports:**
   - `logger` — consola singleton created via `createConsola()`
   - `initializeLogger(options)` — configures level, reporters, color, audit context
   - `setAuditContext(ctx)` — sets command metadata (worktreePath, prNumber, etc.) for audit entries
   - `parseLogLevel(value: string): number | undefined` — maps string level names to consola numeric levels
   - `LogLevel` — re-export a compatibility object mapping `{ SILENT, ERROR, WARN, INFO, DEBUG, TRACE }` to consola numeric values (for consumers that import `LogLevel` from logger.ts). Values: `SILENT=-999, ERROR=0, WARN=1, INFO=3, DEBUG=4, TRACE=5`.

   **`initializeLogger(options)` signature:**

   ```typescript
   interface LoggerOptions {
     verbose?: boolean;
     quiet?: boolean;
     noColor?: boolean;
     json?: boolean;
     commandName?: string;
   }
   ```

   **Level resolution (in `initializeLogger`):**
   - If `options.quiet` → consola level 0 (error only)
   - Else if `options.verbose` → consola level 4 (debug)
   - Else if `process.env.GWT_LOG_LEVEL` → `parseLogLevel()` result
   - Else if `process.env.DEBUG === 'newpr' || process.env.DEBUG === '*' || process.env.DEBUG === '1'` → consola level 4 (debug), AND print deprecation warning to stderr exactly once: `"WARNING: DEBUG=newpr is deprecated, use GWT_LOG_LEVEL=debug"`
   - Else → consola level 3 (info, the default)
   - CLI flag > env var > default (per user decision)

   **Custom AuditFileReporter (implements ConsolaReporter):**
   - Constructor takes `filePath: string`
   - On construction: `fs.mkdirSync(dir, { recursive: true })`, call `rotateIfNeeded()`, open `fs.createWriteStream(filePath, { flags: 'a' })`
   - `log(logObj, ctx)` method writes entries. Default format: human-readable text line `[TIMESTAMP] LEVEL [TAG] message`. If json mode is active, write JSONL `{ timestamp, level, tag, message }`.
   - `close()` method ends the stream
   - Wrap file operations in try/catch — if audit logging fails, warn once to stderr and continue (do not crash)

   **Rotation logic** (`rotateIfNeeded(filePath)`):
   - `MAX_AUDIT_LOG_SIZE = 10 * 1024 * 1024` (10MB)
   - `MAX_AUDIT_LOG_FILES = 3`
   - If file exists and size > max, shift: `audit.log.2` deleted, `audit.log.1` → `.2`, `audit.log` → `.1`

   **Custom ConditionalStderrReporter (implements ConsolaReporter):**
   - Constructor takes `verbose: boolean, useColors: boolean`
   - `log(logObj, ctx)`: if `logObj.level < 2` (warn/error) → always write to `process.stderr`. If `logObj.level >= 2` → write only if `verbose === true`.
   - Format: `[LEVEL]` prefix, optional `[tag]`, message. Apply ANSI colors for level labels if `useColors` is true (red for error, yellow for warn, cyan for info, gray for debug).

   **Audit session tracking (`setAuditContext` + process exit handler):**
   - Module-level `auditContext` object: `{ command, startTime, cwd, gitBranch, worktreePath?, prNumber?, exitCode? }`
   - `setAuditContext(ctx)` merges into `auditContext`
   - In `initializeLogger`, if `commandName` is provided: set `auditContext.command = commandName`, `auditContext.startTime = Date.now()`, `auditContext.cwd = process.cwd()`. Try to get git branch via a simple `execSync('git rev-parse --abbrev-ref HEAD')` wrapped in try/catch (return 'unknown' on failure).
   - Register `process.on('exit', (code) => { ... })` that writes a summary entry using `fs.appendFileSync()` (MUST be synchronous — Node.js does not process async after 'exit'). Entry includes: timestamp, command, cwd, gitBranch, exitCode, duration (Date.now() - startTime), worktreePath, prNumber.

   **Logger creation:**
   - Create with `createConsola({ level: 3, reporters: [] })` — reporters added in `initializeLogger()`
   - Do NOT use `consola.wrapConsole()` or `consola.wrapStd()` (per research anti-patterns — existing console.log calls in CLI files are user-facing output, not logging)
   - Export the instance as `export const logger = createConsola(...)` to maintain the same import name

   **`parseLogLevel` mapping:**
   - 'silent' → -999, 'error' → 0, 'warn' → 1, 'info' → 3, 'debug' → 4, 'trace' → 5
   - Also accept 'verbose' → 4, 'warning' → 1
   - Return `undefined` for unrecognized values

   **Important notes:**
   - Do NOT initialize reporters at module-load time. The logger starts with empty reporters. `initializeLogger()` must be called before reporters are active.
   - The deprecation warning for `DEBUG=newpr` must print exactly once per process (use a module-level boolean flag).
   - Import `getGlobalDataDir` from `./constants.js` for the audit log path (created in Task 2).
     </action>
     <verify>
   - `npm run build` succeeds (TypeScript compiles)
   - `import { logger, initializeLogger, parseLogLevel, LogLevel } from './logger.js'` resolves
   - `parseLogLevel('debug')` returns `4`, `parseLogLevel('error')` returns `0`
     </verify>
     <done>
     `src/lib/logger.ts` is a complete consola-based replacement with AuditFileReporter, ConditionalStderrReporter, audit session tracking, DEBUG=newpr deprecation warning, and all documented exports. The old Logger class, ChildLogger class, and hand-rolled singleton are gone.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Add getGlobalDataDir to constants.ts and make colors.ts mutable</name>
  <files>
    src/lib/constants.ts
    src/lib/colors.ts
  </files>
  <action>
1. **`src/lib/constants.ts`** — Add `getGlobalDataDir()` function:

```typescript
/**
 * Get the global data directory path (for audit logs)
 * - Linux: $XDG_DATA_HOME/git-worktree-tools or ~/.local/share/git-worktree-tools
 * - macOS: ~/Library/Application Support/git-worktree-tools
 * - Windows: %APPDATA%/git-worktree-tools
 */
export function getGlobalDataDir(): string {
  if (process.platform === 'win32') {
    const appData = process.env.APPDATA || path.join(os.homedir(), 'AppData', 'Roaming');
    return path.join(appData, PACKAGE_NAME);
  }
  if (process.platform === 'darwin') {
    return path.join(os.homedir(), 'Library', 'Application Support', PACKAGE_NAME);
  }
  // Linux and others: XDG_DATA_HOME
  const xdgData = process.env.XDG_DATA_HOME || path.join(os.homedir(), '.local', 'share');
  return path.join(xdgData, PACKAGE_NAME);
}
```

Also update existing constants:

- Change `MAX_LOG_FILE_SIZE` from `5 * 1024 * 1024` to `10 * 1024 * 1024` (10MB, per user decision)
- Remove the `LogLevel` enum from `constants.ts` entirely — it is now provided by `logger.ts` as a compatibility mapping to consola levels. This is a **breaking change** for the `constants` public export via `src/index.ts`, but the `LogLevel` re-export from `logger.ts` provides continuity.

Wait — check `src/index.ts`: it exports `* as constants from './lib/constants.js'`. Removing `LogLevel` from constants would break consumers who do `import { constants } from '@camaradesuk/git-worktree-tools'; constants.LogLevel.DEBUG`. To minimize breakage:

- Keep `LogLevel` in `constants.ts` BUT update its values to match consola levels: `SILENT = -999, ERROR = 0, WARN = 1, INFO = 3, DEBUG = 4, TRACE = 5`. Also update `DEFAULT_LOG_LEVEL` to use the new `LogLevel.INFO` value (which is now `3` — same numeric value, so no functional change there).
- In `logger.ts`, import `LogLevel` from `constants.js` and re-export it (this keeps backward compatibility).

2. **`src/lib/colors.ts`** — Make color state mutable:
   - Change `const useColors = shouldUseColors();` to `let colorEnabled = shouldUseColors();`
   - Add exported function:
     ```typescript
     export function setColorEnabled(enabled: boolean): void {
       colorEnabled = enabled;
     }
     ```
   - Update `colorize()` to use `colorEnabled` instead of `useColors`
   - Update semantic functions (`success`, `warning`, `error`, `info`) that reference `useColors` to reference `colorEnabled` instead
   - Ensure the variable name change is applied consistently throughout the file (the `useColors` variable is referenced in `colorize()` and in the icon selection for `success()`, `warning()`, `error()`, `info()`)
     </action>
     <verify>
   - `npm run build` succeeds
   - `import { getGlobalDataDir } from './constants.js'` resolves
   - `import { setColorEnabled } from './colors.js'` resolves
   - `LogLevel.ERROR === 0`, `LogLevel.INFO === 3`, `LogLevel.DEBUG === 4`
   - Calling `setColorEnabled(false)` then `red('test')` returns `'test'` (no ANSI codes)
     </verify>
     <done>
     `constants.ts` has `getGlobalDataDir()` for audit log paths and `LogLevel` enum updated to consola-compatible values. `colors.ts` has `setColorEnabled()` and uses a mutable color flag. `MAX_LOG_FILE_SIZE` is 10MB.
     </done>
     </task>

<task type="auto">
  <name>Task 3: Update 7 library consumers to new consola-compatible logger API</name>
  <files>
    src/lib/config.ts
    src/lib/global-config.ts
    src/lib/global-check.ts
    src/lib/wtlink/config-manifest.ts
    src/lib/config-migration/runner.ts
    src/lib/config-migration/detector.ts
    src/cli/wt.ts
  </files>
  <action>
**For `src/lib/config.ts`, `src/lib/global-config.ts`, `src/lib/global-check.ts`, `src/lib/wtlink/config-manifest.ts`, `src/lib/config-migration/runner.ts`, `src/lib/config-migration/detector.ts`:**

These 6 files import `{ logger }` from logger.ts and call `.warn()`, `.debug()`, `.info()`. The consola instance exposes the same method names (`.warn()`, `.debug()`, `.info()`, `.error()`), so these calls should work with minimal changes.

Review each file and update as needed:

- The import path (`'../logger.js'` or `'../../logger.js'` etc.) stays the same
- If any file imports `LogLevel` from `'../logger.js'`, update the import to match the new exports
- If any file calls `logger.child('context')` — consola equivalent is `logger.withTag('context')`. Check if any of the 6 files use `.child()`.
- If any file calls `logger.isDebug()` or `logger.isTrace()` — replace with `logger.level >= 4` or `logger.level >= 5`
- If any file calls `logger.setContext()` or `logger.setLevel()` — update to consola equivalent (`logger.level = N`)
- If any file references `logger.initialize()` — this is now `initializeLogger()` (standalone function, not method)
- The `logger.error()`, `logger.warn()`, `logger.info()`, `logger.debug()`, `logger.trace()` calls are identical in consola and should work as-is

**For `src/cli/wt.ts`:**

This file currently imports `{ initializeLogger, parseLogLevel, LogLevel }` from `'../lib/logger.js'` and has its own `initializeLoggerFromCliFlags()` and `initializeCliEnvironment()` functions.

Update `wt.ts`:

1. Update the import to match the new `initializeLogger` signature (the new one takes `{ verbose, quiet, noColor, json, commandName }` instead of `{ verbose, debug, quiet, logFile, configLogLevel, configLogFile }`)
2. Simplify `initializeLoggerFromCliFlags()`: parse `--verbose`, `--quiet`, `--no-color` from `process.argv` and call `initializeLogger({ verbose, quiet, noColor, commandName: 'wt' })`
3. Simplify `initializeCliEnvironment()`: the new logger handles `GWT_LOG_LEVEL` env var internally, so config-based log level override is no longer needed in wt.ts. Keep the `loadConfig()` and `checkAndWarnGlobalInstall()` calls. Remove the re-initialization of logger with config log level/file (the new logger reads env vars in `initializeLogger()`).
4. Remove the `--debug` and `--log-file` yargs options from wt.ts (replaced by `--verbose` for debug output and audit log is automatic). Keep `--verbose`, `--quiet`. Add `--no-color` option.
5. Remove the `import { parseLogLevel, LogLevel }` if no longer used directly in wt.ts (only needed if wt.ts does manual level mapping; the new initializeLogger handles everything).

IMPORTANT: Do NOT change any `console.log()` calls in CLI files — those are user-facing output (Phase 2 concern). Only change logger/debug infrastructure.
</action>
<verify> - `npm run build` succeeds with zero errors - `npm test` passes — existing tests for config.ts, global-config.ts, etc. should still pass since the logger API is compatible - Grep for any remaining references to the old `Logger` class, `ChildLogger`, `logger.child()`, `logger.setContext()`, `logger.initialize()`, `logger.close()` — there should be zero hits in production code (test files updated in Plan 03)
</verify>
<done>
All 7 library consumers compile and work with the consola-based logger. `wt.ts` calls `initializeLogger()` with the new signature and has `--no-color` support. No old Logger class references remain in production code.
</done>
</task>

</tasks>

<verification>
1. `npm run build` compiles with zero errors
2. `npm test` passes (existing tests that don't directly test logger internals should pass)
3. `node -e "const { logger } = require('./dist/lib/logger.js')"` does not throw (ESM: use dynamic import)
4. `grep -r "class Logger" src/lib/logger.ts` returns zero matches (old class is gone)
5. `grep -r "getGlobalDataDir" src/lib/constants.ts` returns the new function
6. `grep -r "setColorEnabled" src/lib/colors.ts` returns the new function
</verification>

<success_criteria>

- consola@^3.4.2 is installed as a dependency
- src/lib/logger.ts is fully replaced with consola wrapper (not extended)
- All 7 library consumers compile without changes to their import paths
- AuditFileReporter writes to platform-specific XDG data directory
- ConditionalStderrReporter implements the verbose/quiet stderr rules
- colors.ts supports runtime color disable
- constants.ts has getGlobalDataDir() and updated LogLevel values
  </success_criteria>

<output>
After completion, create `.planning/phases/01-logger-wiring/01-01-SUMMARY.md`
</output>
