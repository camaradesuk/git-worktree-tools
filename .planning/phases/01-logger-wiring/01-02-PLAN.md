---
phase: 01-logger-wiring
plan: 02
type: execute
wave: 2
depends_on: ['01-01']
files_modified:
  - src/lib/newpr/args.ts
  - src/lib/cleanpr/args.ts
  - src/lib/lswt/args.ts
  - src/cli/wtlink.ts
  - src/cli/newpr.ts
  - src/cli/cleanpr.ts
  - src/cli/lswt.ts
  - src/cli/wt/new.ts
  - src/cli/wt/clean.ts
  - src/cli/wt/list.ts
  - src/cli/wt/link.ts
  - src/cli/wt/run-command.ts
autonomous: true

must_haves:
  truths:
    - "Running `newpr --verbose 'test'` produces debug output to stderr via the shared logger"
    - 'Running `cleanpr --quiet --all` suppresses all output except errors'
    - 'Running `lswt --no-color` produces output with no ANSI escape codes'
    - 'Running `wtlink --verbose manage` produces debug output to stderr'
    - "Running `wt new --verbose 'test'` forwards --verbose to the spawned newpr child process"
    - 'The local debug() function and DEBUG_ENABLED constant no longer exist in newpr.ts'
    - 'All debug() calls in newpr.ts are replaced with logger.debug() calls'
    - "Running `DEBUG=newpr newpr 'test'` activates debug level with a deprecation warning printed once"
  artifacts:
    - path: 'src/lib/newpr/args.ts'
      provides: 'parseArgs with --verbose, --quiet, --no-color support'
      contains: "'--verbose'"
    - path: 'src/lib/cleanpr/args.ts'
      provides: 'parseArgs with --verbose, --quiet, --no-color support'
      contains: "'--verbose'"
    - path: 'src/lib/lswt/args.ts'
      provides: 'parseArgs with --verbose, --quiet, --no-color support'
      contains: "'--verbose'"
    - path: 'src/cli/newpr.ts'
      provides: 'initializeLogger call, no local debug()'
      contains: 'initializeLogger'
    - path: 'src/cli/cleanpr.ts'
      provides: 'initializeLogger call'
      contains: 'initializeLogger'
    - path: 'src/cli/lswt.ts'
      provides: 'initializeLogger call'
      contains: 'initializeLogger'
  key_links:
    - from: 'src/cli/newpr.ts'
      to: 'src/lib/logger.ts'
      via: 'import { logger, initializeLogger }'
      pattern: 'initializeLogger'
    - from: 'src/cli/wt/new.ts'
      to: 'src/cli/wt/run-command.ts'
      via: 'runSubcommand with forwarded flags'
      pattern: '--verbose|--quiet|--no-color'
    - from: 'src/lib/newpr/args.ts'
      to: 'src/lib/newpr/types.ts'
      via: 'Options type with verbose/quiet/noColor fields'
      pattern: 'verbose|quiet|noColor'
---

<objective>
Wire `--verbose`, `--quiet`, and `--no-color` flags into all 4 legacy CLI entry points (`newpr`, `cleanpr`, `lswt`, `wtlink`). Add `initializeLogger()` calls at startup in each CLI. Remove the `newpr`-specific `debug()` function and `DEBUG_ENABLED` constant, replacing all calls with `logger.debug()`. Forward the three new flags from `wt` subcommand wrappers to child processes.

Purpose: After this plan, every CLI binary produces debug output through the shared logger when `--verbose` is passed, and `GWT_LOG_LEVEL` is the single control point (with `DEBUG=newpr` backward-compatible but deprecated).

Output: All 4 legacy CLIs and all 4 wt wrappers wire logging flags end-to-end.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-logger-wiring/01-CONTEXT.md
@.planning/phases/01-logger-wiring/01-RESEARCH.md
@.planning/phases/01-logger-wiring/01-01-SUMMARY.md
@src/lib/newpr/args.ts
@src/lib/newpr/types.ts
@src/lib/cleanpr/args.ts
@src/lib/cleanpr/types.ts
@src/lib/lswt/args.ts
@src/lib/lswt/types.ts
@src/cli/newpr.ts
@src/cli/cleanpr.ts
@src/cli/lswt.ts
@src/cli/wtlink.ts
@src/cli/wt/new.ts
@src/cli/wt/clean.ts
@src/cli/wt/list.ts
@src/cli/wt/link.ts
@src/cli/wt/run-command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --verbose/--quiet/--no-color to all 4 legacy arg parsers and types</name>
  <files>
    src/lib/newpr/args.ts
    src/lib/newpr/types.ts
    src/lib/cleanpr/args.ts
    src/lib/cleanpr/types.ts
    src/lib/lswt/args.ts
    src/lib/lswt/types.ts
    src/cli/wtlink.ts
  </files>
  <action>
**For each of `newpr/args.ts`, `cleanpr/args.ts`, `lswt/args.ts`:**

These use hand-rolled `parseArgs()` with a switch statement. Add three new cases to each:

```typescript
case '--verbose':
  options.verbose = true;
  break;

case '--quiet':
  options.quiet = true;
  break;

case '--no-color':
  options.noColor = true;
  break;
```

**For `newpr/args.ts` specifically:**

- The `-v` short flag does NOT exist yet in newpr's parser (it does in lswt's for `--verbose`). Add `-v` as an alias for `--verbose` in newpr. But be careful: newpr does NOT already use `-v`. Add the case.
- Validate mutual exclusivity: if both `--verbose` and `--quiet` are passed, return `{ kind: 'error', message: '--verbose and --quiet cannot be used together' }`. Add this validation after the parsing loop.
- Update `getHelpText()` to document the three new flags under a "Logging Options" section.

**For `cleanpr/args.ts`:**

- No existing short-flag conflicts. Add all three flags.
- Update `getHelpText()` with logging options section.

**For `lswt/args.ts`:**

- CONFLICT: `-v` is already mapped to `--verbose` (which means "show full paths" in lswt). The logging `--verbose` is DIFFERENT from lswt's `--verbose` (which sets `options.verbose = true` for display purposes). The resolution: lswt's existing `--verbose` flag keeps its existing display meaning AND also activates logger verbose mode. No separate flag needed — the arg parser already sets `options.verbose = true` for `-v`/`--verbose`. Just add `--quiet` and `--no-color` cases. The CLI entry point (Plan task 2) will use `options.verbose` for both purposes.
- Update `getHelpText()` with logging options section (--quiet and --no-color only, since --verbose is already documented for display).

**For `src/cli/wtlink.ts` (yargs-based):**

Add three global options to the yargs chain (before the `.command()` calls):

```typescript
.option('verbose', {
  alias: 'v',
  type: 'boolean',
  description: 'Enable verbose debug output',
  default: false,
  global: true,
})
.option('quiet', {
  type: 'boolean',
  description: 'Suppress all output except errors',
  default: false,
  global: true,
})
.option('no-color', {
  type: 'boolean',
  description: 'Disable colored output',
  default: false,
  global: true,
})
```

WAIT — `wtlink manage` already has a `--verbose` / `-v` option for "show full file list." This is a conflict similar to lswt. Resolution: the existing `manage` subcommand's `--verbose` already does `argv.verbose`. When we add a global `--verbose`, yargs merges them. The `manage` handler already receives `argv.verbose` — it will now also trigger logger verbose. This is acceptable: verbose means "more detail" in both cases. However, the `manage` subcommand's `verbose` option must be removed from the subcommand level (it becomes global). Remove the `.option('verbose', ...)` from the `manage` builder since it's now global.

**Type updates:**

For each types.ts file (`src/lib/newpr/types.ts`, `src/lib/cleanpr/types.ts`, `src/lib/lswt/types.ts`), add to the `Options` / `CleanOptions` / `ListOptions` interface:

```typescript
verbose?: boolean;  // (may already exist in some)
quiet?: boolean;
noColor?: boolean;
```

Check each: newpr's `Options` does NOT have verbose/quiet/noColor. cleanpr's `CleanOptions` does NOT have them. lswt's `ListOptions` already has `verbose: boolean` (for display). Add `quiet` and `noColor` to lswt's type.
</action>
<verify> - `npm run build` succeeds - All existing args tests pass: `npm test -- --grep "args"` or similar - Manual check: `parseArgs(['--verbose'])` sets `options.verbose = true` for all 3 parsers - `parseArgs(['--verbose', '--quiet'])` returns an error for newpr and cleanpr
</verify>
<done>
All 4 legacy arg parsers accept `--verbose`, `--quiet`, `--no-color`. Types updated. Help text updated. No existing flags broken.
</done>
</task>

<task type="auto">
  <name>Task 2: Wire initializeLogger into all 4 legacy CLI entry points and migrate newpr debug calls</name>
  <files>
    src/cli/newpr.ts
    src/cli/cleanpr.ts
    src/cli/lswt.ts
    src/cli/wtlink.ts
  </files>
  <action>
**For `src/cli/newpr.ts`:**

1. Add import at top: `import { logger, initializeLogger, setAuditContext } from '../lib/logger.js';`
2. Add import: `import { setColorEnabled } from '../lib/colors.js';`
3. **Remove** the `DEBUG_ENABLED` constant (lines ~59-60) and the `debug()` function (lines ~75-84) entirely.
4. In `main()`, after `parseArgs()` succeeds and before any business logic, add:
   ```typescript
   // Initialize logger
   initializeLogger({
     verbose: options.verbose,
     quiet: options.quiet,
     noColor: options.noColor,
     json: options.json,
     commandName: 'newpr',
   });
   if (options.noColor) {
     setColorEnabled(false);
   }
   ```
5. Replace ALL `debug(...)` calls with `logger.debug(...)` calls throughout the file. The debug() function accepted `(message, data?)` where data was a Record. For consola, use: `logger.debug(message, data)` or simply `logger.debug(message)` when no data.
   Specifically:
   - `debug('Could not determine main worktree root...')` → `logger.debug('Could not determine main worktree root, skipping config file linking')`
   - `debug('linkConfigFiles is false...')` → `logger.debug('linkConfigFiles is false, skipping auto-link')`
   - `debug('linkConfigFiles is true...')` → `logger.debug('linkConfigFiles is true, auto-linking')`
   - `debug('Non-interactive mode...')` → `logger.debug('Non-interactive mode, defaulting to auto-link')`
   - `debug('State analysis complete', { scenario, ... })` → `logger.debug('State analysis complete', { scenario, branchType: state.branchType, ... })`
   - `debug('User selected action', { ... })` → `logger.debug('User selected action', { action: action.action, ... })`
   - `debug('Before executeStateAction', { ... })` → `logger.debug('Before executeStateAction', { ... })`
   - `debug('After executeStateAction', { ... })` → `logger.debug('After executeStateAction', { ... })`
   - `debug('Before checkout', { ... })` → `logger.debug('Before checkout', { ... })`
   - `debug('After checkout', { ... })` → `logger.debug('After checkout', { ... })`
   - `debug('Committed staged changes')` → `logger.debug('Committed staged changes')`
   - `debug('Created empty commit...')` → `logger.debug('Created empty commit (no staged files found)')`
   - `debug('Plan generation skipped', { ... })` → `logger.debug('Plan generation skipped', { reason: decision.reason })`
6. The `createHookRunner()` calls pass `verbose: DEBUG_ENABLED` — change these to `verbose: options.verbose ?? false` (or check `logger.level >= 4`).
7. Add `setAuditContext({ prNumber, worktreePath, branchName })` calls at appropriate points where these values become known (after PR creation, after worktree creation).

**For `src/cli/cleanpr.ts`:**

1. Add imports: `import { logger, initializeLogger } from '../lib/logger.js';` and `import { setColorEnabled } from '../lib/colors.js';`
2. In `main()`, after `parseArgs()` succeeds, add:
   ```typescript
   initializeLogger({
     verbose: options.verbose,
     quiet: options.quiet,
     noColor: options.noColor,
     json: options.json,
     commandName: 'cleanpr',
   });
   if (options.noColor) {
     setColorEnabled(false);
   }
   ```
   Note: cleanpr's `parseResult` yields `{ prNumber, options }`. The verbose/quiet/noColor fields need to be on `options` (added in Task 1).
3. Add `logger.debug()` calls at key decision points: worktree scanning, cleanup decisions, branch deletion attempts. These don't exist today — add them to provide debug visibility:
   - `logger.debug('Scanning worktrees', { repoRoot, pattern: config.worktreePattern })`
   - `logger.debug('Found worktrees', { count: worktrees.length })`
   - `logger.debug('Cleanable worktrees', { count: cleanable.length })`

**For `src/cli/lswt.ts`:**

1. Add imports: `import { initializeLogger } from '../lib/logger.js';` and `import { setColorEnabled } from '../lib/colors.js';`
2. In `main()`, after `parseArgs()` succeeds, add:
   ```typescript
   initializeLogger({
     verbose: options.verbose,
     quiet: options.quiet,
     noColor: options.noColor,
     json: options.json,
     commandName: 'lswt',
   });
   if (options.noColor) {
     setColorEnabled(false);
   }
   ```

**For `src/cli/wtlink.ts` (yargs):**

1. Add imports: `import { initializeLogger } from '../lib/logger.js';` and `import { setColorEnabled } from '../lib/colors.js';`
2. Add a yargs `.middleware()` call (before command definitions) that initializes the logger:
   ```typescript
   .middleware((argv) => {
     initializeLogger({
       verbose: argv.verbose as boolean,
       quiet: argv.quiet as boolean,
       noColor: argv['no-color'] as boolean || argv.noColor as boolean,
       json: argv.json as boolean,
       commandName: 'wtlink',
     });
     if (argv['no-color'] || argv.noColor) {
       setColorEnabled(false);
     }
   })
   ```
   Place this middleware after the global options are defined but before the command definitions.
   </action>
   <verify> - `npm run build` succeeds - `grep -r "DEBUG_ENABLED" src/cli/newpr.ts` returns zero matches - `grep -r "function debug" src/cli/newpr.ts` returns zero matches - `grep -r "initializeLogger" src/cli/newpr.ts src/cli/cleanpr.ts src/cli/lswt.ts src/cli/wtlink.ts` returns matches in all 4 files - `npm test` passes
   </verify>
   <done>
   All 4 legacy CLI entry points call `initializeLogger()` at startup with the parsed flags. newpr.ts has zero references to `debug()`, `DEBUG_ENABLED`, or the old debug mechanism. All former `debug()` calls route through `logger.debug()`.
   </done>
   </task>

<task type="auto">
  <name>Task 3: Forward --verbose/--quiet/--no-color from wt subcommand wrappers to child processes</name>
  <files>
    src/cli/wt/new.ts
    src/cli/wt/clean.ts
    src/cli/wt/list.ts
    src/cli/wt/link.ts
    src/cli/wt/run-command.ts
  </files>
  <action>
The `wt` binary delegates to child processes via `runSubcommand()`. Each wt subcommand wrapper must forward `--verbose`, `--quiet`, and `--no-color` to the child process args so the spawned legacy binary initializes its logger correctly.

**`src/cli/wt/run-command.ts`:**
Also set `GWT_LOG_LEVEL` in the child process environment as a belt-and-suspenders approach. The child inherits `process.env` which includes any `GWT_LOG_LEVEL` already set, but the `wt` binary might have parsed `--verbose` from CLI which needs to reach the child. Update `runSubcommand()` to accept optional env overrides:

```typescript
export function runSubcommand(
  cliName: string,
  args: string[],
  envOverrides?: Record<string, string>
): never {
  const cliPath = path.resolve(__dirname, `../${cliName}.js`);
  const result = spawnSync(process.execPath, [cliPath, ...args], {
    stdio: 'inherit',
    env: { ...process.env, ...envOverrides },
  });
  process.exit(result.status ?? 1);
}
```

Also update `runSubcommandForResult()` with the same `envOverrides` parameter.

**For each of `src/cli/wt/new.ts`, `clean.ts`, `list.ts`, `link.ts`:**

These files access `argv` from yargs and build an `args` array before calling `runSubcommand()`. The `wt` binary has global `--verbose`, `--quiet` options. However, `argv.verbose` in the wt context is a count (`-v` = 1, `-vv` = 2). The child process just needs `--verbose` (boolean). Also, `wt.ts` has `--no-color` added in Plan 01 Task 3.

The yargs global options from `wt.ts` are available on `argv` in each subcommand handler. However, there's a subtlety: yargs' global options appear as `argv.verbose`, `argv.quiet`, but NOT `argv['no-color']` — yargs converts kebab to camelCase: `argv.noColor`.

For EACH handler, **before** the `runSubcommand()` call, add flag forwarding:

```typescript
// Forward global logging flags to child process
if (argv.verbose) {
  args.push('--verbose');
}
if (argv.quiet) {
  args.push('--quiet');
}
if (argv.noColor) {
  args.push('--no-color');
}
```

**Special cases:**

- `wt/new.ts`: The `argv` type interface (`NewArgs`) needs `verbose`, `quiet`, and `noColor` fields. But these come from the global yargs options defined in `wt.ts`, not from the subcommand builder. Yargs passes global options through to handlers, but TypeScript won't know about them unless the interface includes them. Add `verbose?: number; quiet?: boolean; noColor?: boolean;` to the `NewArgs` interface. Actually — yargs global options are available on all subcommand argv. The safest approach: access them via `(argv as any).verbose` or cast. Better: add the fields to each interface.

- `wt/list.ts`: Already has `verbose` in its interface (for the lswt display meaning). The global `--verbose` from wt and the subcommand `--verbose` from list merge in yargs. When `wt -v list` is run, `argv.verbose` will be truthy. This is fine — it already forwards `--verbose` to lswt. Just add `--quiet` and `--no-color` forwarding.

- `wt/link.ts`: Already has `verbose` in its interface (for wtlink manage's verbose). Same situation as list — already forwards `--verbose`. Add `--quiet` and `--no-color`.

- `wt/clean.ts`: Does NOT have verbose in its interface. Add `verbose?: number | boolean; quiet?: boolean; noColor?: boolean;` and add forwarding.

For all 4 wrappers, also forward via environment as backup (belt-and-suspenders). In the handler:

```typescript
const envOverrides: Record<string, string> = {};
if (argv.verbose) {
  envOverrides.GWT_LOG_LEVEL = 'debug';
}
if (argv.quiet) {
  envOverrides.GWT_LOG_LEVEL = 'error';
}
if (argv.noColor) {
  envOverrides.NO_COLOR = '1';
}
runSubcommand('newpr', args, envOverrides);
```

  </action>
  <verify>
    - `npm run build` succeeds
    - `grep -r "no-color\|noColor" src/cli/wt/new.ts src/cli/wt/clean.ts src/cli/wt/list.ts src/cli/wt/link.ts` shows the forwarding in all 4 files
    - Manually verify: `node dist/cli/wt.js new --help` still works
    - `npm test` passes
  </verify>
  <done>
    All 4 wt subcommand wrappers forward `--verbose`, `--quiet`, `--no-color` flags and `GWT_LOG_LEVEL`/`NO_COLOR` env vars to spawned child processes. `runSubcommand()` accepts optional env overrides.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `npm test` passes
3. `grep -rn "DEBUG_ENABLED\|function debug" src/cli/newpr.ts` returns zero matches
4. `grep -rn "initializeLogger" src/cli/newpr.ts src/cli/cleanpr.ts src/cli/lswt.ts src/cli/wtlink.ts` returns matches in all 4 files
5. `grep -rn "'--verbose'\|'--quiet'\|'--no-color'" src/lib/newpr/args.ts src/lib/cleanpr/args.ts src/lib/lswt/args.ts` returns matches
6. `grep -rn "noColor\|no-color" src/cli/wt/new.ts src/cli/wt/clean.ts src/cli/wt/list.ts src/cli/wt/link.ts` returns forwarding code
</verification>

<success_criteria>

- All 4 legacy CLIs accept --verbose, --quiet, --no-color
- All 4 legacy CLIs call initializeLogger() at startup
- newpr.ts debug() function and DEBUG_ENABLED are completely removed
- All debug() calls in newpr.ts replaced with logger.debug()
- All 4 wt wrappers forward logging flags to child processes
- Existing tests pass (no regressions)
  </success_criteria>

<output>
After completion, create `.planning/phases/01-logger-wiring/01-02-SUMMARY.md`
</output>
